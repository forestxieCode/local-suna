# ============================================================================
# KORTIX 本地部署 - 中国友好配置
# ============================================================================
# 此Docker Compose文件提供完整的本地开发/测试环境，包括：
# - PostgreSQL 数据库
# - MinIO 对象存储（S3兼容）
# - Redis 缓存
# - Mailpit 邮件测试
# - Kortix Backend
# - Kortix Frontend
#
# 特点：
# ✅ 完全免费
# ✅ 无需VPN
# ✅ 完整功能
# ✅ 快速启动
#
# 快速开始:
#   1. cp .env.local.example .env
#   2. docker compose -f docker-compose.local.yaml up -d
#   3. 访问 http://localhost:3000
#
# 访问地址:
#   - 前端:          http://localhost:3000
#   - 后端API:       http://localhost:8000
#   - MinIO控制台:   http://localhost:9001 (minioadmin/minioadmin)
#   - Mailpit:       http://localhost:8025
#   - PostgreSQL:    localhost:5432 (kortix/kortix123)
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # PostgreSQL 数据库
  # ============================================================================
  postgres:
    image: postgres:14-alpine
    container_name: kortix-postgres
    environment:
      POSTGRES_DB: kortix
      POSTGRES_USER: kortix
      POSTGRES_PASSWORD: kortix123
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kortix -d kortix"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ============================================================================
  # MinIO 对象存储（S3兼容）
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: kortix-minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_BROWSER_REDIRECT_URL: http://localhost:9001
    ports:
      - "9000:9000"  # API端口
      - "9001:9001"  # 控制台端口
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    restart: unless-stopped

  # 初始化MinIO Bucket
  minio-init:
    image: minio/mc:latest
    container_name: kortix-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/kortix-files --ignore-existing;
      mc anonymous set download myminio/kortix-files;
      echo 'MinIO初始化完成';
      "

  # ============================================================================
  # Redis 缓存
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: kortix-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --save 60 1 --loglevel warning
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  # ============================================================================
  # Mailpit 邮件测试工具
  # ============================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: kortix-mailpit
    ports:
      - "1025:1025"  # SMTP端口
      - "8025:8025"  # Web界面
    environment:
      MP_MAX_MESSAGES: 1000
      MP_DATABASE: /data/mailpit.db
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    volumes:
      - mailpit_data:/data
    restart: unless-stopped

  # ============================================================================
  # Kortix Backend
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: kortix-backend
    ports:
      - "8000:8000"
    volumes:
      - ./backend/.env:/app/.env:ro
      - /var/run/docker.sock:/var/run/docker.sock  # Docker沙箱支持
    environment:
      # 数据库配置
      - DATABASE_PROVIDER=local
      - LOCAL_DB_HOST=postgres
      - LOCAL_DB_PORT=5432
      - LOCAL_DB_NAME=kortix
      - LOCAL_DB_USER=kortix
      - LOCAL_DB_PASSWORD=kortix123
      
      # 存储配置
      - STORAGE_PROVIDER=local
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_BUCKET=kortix-files
      - MINIO_USE_SSL=false
      
      # Redis配置
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=
      - REDIS_SSL=false
      
      # 邮件配置
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - SMTP_USER=
      - SMTP_PASSWORD=
      - SMTP_FROM=noreply@kortix.local
      
      # 沙箱配置
      - SANDBOX_PROVIDER=docker
      - DOCKER_HOST=unix:///var/run/docker.sock
      
      # LLM配置（使用Ollama本地模型）
      - MAIN_LLM=ollama
      - MAIN_LLM_MODEL=qwen2.5:7b
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      
      # 其他
      - CLOUD_PROVIDER=local
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped

  # ============================================================================
  # Kortix Frontend
  # ============================================================================
  frontend:
    init: true
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
      args:
        NEXT_PUBLIC_BACKEND_URL: ${NEXT_PUBLIC_BACKEND_URL:-http://localhost:8000/v1}
        NEXT_PUBLIC_URL: ${NEXT_PUBLIC_URL:-http://localhost:3000}
        NEXT_PUBLIC_ENV_MODE: ${NEXT_PUBLIC_ENV_MODE:-LOCAL}
        PNPM_LOCKFILE_MODE: --no-frozen-lockfile
    container_name: kortix-frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
    restart: unless-stopped

# ============================================================================
# 持久化卷
# ============================================================================
volumes:
  postgres_data:
    driver: local
  minio_data:
    driver: local
  redis_data:
    driver: local
  mailpit_data:
    driver: local

# ============================================================================
# 网络配置
# ============================================================================
networks:
  default:
    name: kortix-network
    driver: bridge
