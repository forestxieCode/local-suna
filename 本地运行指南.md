# 🚀 Kortix 本地运行快速指南（5分钟）

## 方案选择

### 🎯 推荐：本地部署 + 阿里云百炼 LLM ⭐

```bash
# 本地运行：PostgreSQL + MinIO + Redis + Frontend + Backend + Docker Sandbox
# 阿里云：只有大语言模型（百炼 DashScope）
```

**优势**：
- ✅ 成本低（只有 LLM 按量付费，约 ¥40-400/月）
- ✅ 数据完全本地存储（安全、隐私）
- ✅ 使用阿里云百炼高质量 LLM（不占本地资源）
- ✅ 本地开发体验好（热重载、调试方便）
- ✅ 5分钟启动

**成本**: 约 ¥40-400/月（仅 LLM，按实际使用量付费）

---

### 方案二：完全本地部署（完全免费）

```bash
# 使用 Ollama 本地 LLM
# 所有服务都在本地运行
```

**优势**：
- ✅ 完全免费（¥0成本）
- ✅ 完全离线可用
- ✅ 数据完全本地

**劣势**：
- ⚠️ 需要本地运行大模型（占用 GPU/CPU 资源）
- ⚠️ LLM 质量和速度不如云端百炼

---

### 方案三：完全阿里云部署（生产环境）

参考: `docs/CHINA_DEPLOYMENT_GUIDE.md`

**成本**: 约 ¥430-1080/月

---

## 📋 前置要求

### 必需安装

1. **Docker Desktop**
   - Windows: https://www.docker.com/products/docker-desktop
   - 确保 Docker 正在运行

2. **Node.js 20+** 和 **pnpm**
   ```bash
   # 检查版本
   node --version  # 应该 >= 20
   
   # 安装 pnpm
   npm install -g pnpm
   ```

3. **Python 3.11+** 和 **Poetry**
   ```bash
   # 检查版本
   python --version  # 应该 >= 3.11
   
   # 安装 Poetry
   # Windows PowerShell:
   (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
   ```

4. **阿里云百炼 API Key**（推荐方案需要）
   - 注册地址: https://dashscope.console.aliyun.com/
   - 开通百炼服务并创建 API Key
   - 充值少量金额（建议 ¥50 起）

---

## 🚀 快速开始

### 推荐方案：本地部署 + 阿里云百炼 LLM ⭐

#### 1. 获取阿里云百炼 API Key

**步骤**：
1. 访问 https://dashscope.console.aliyun.com/
2. 登录阿里云账号（没有则注册）
3. 开通百炼服务
4. 创建 API Key（复制保存）
5. 账户充值（建议 ¥50 起步）

#### 2. 克隆项目
```bash
cd D:\project\local-suna
```

#### 3. 配置环境变量
```bash
# 复制本地配置模板
copy .env.local.example .env

# 编辑配置文件
notepad .env
```

**关键配置**（只需修改 LLM 部分）：
```bash
# =============================================================================
# 云服务商（选择本地）
# =============================================================================
CLOUD_PROVIDER=local

# =============================================================================
# LLM服务 - 阿里云百炼（唯一需要云服务的部分）
# =============================================================================
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxx  # 填入你的 API Key
MAIN_LLM=dashscope
MAIN_LLM_MODEL=qwen-turbo  # 经济型：¥2/百万tokens

# 可选的其他模型：
# MAIN_LLM_MODEL=qwen-max     # 最强：¥40/百万tokens
# MAIN_LLM_MODEL=qwen-plus    # 平衡：¥4/百万tokens
# MAIN_LLM_MODEL=qwen-long    # 长文本：¥0.5/百万tokens

# =============================================================================
# 其他配置保持默认即可（都使用本地服务）
# =============================================================================
# 数据库: 本地 PostgreSQL (Docker)
# 存储: 本地 MinIO (Docker)
# 沙箱: 本地 Docker
# 邮件: 本地 Mailpit (Docker)
```

#### 4. 启动所有本地服务（一键启动）
```bash
# 启动 PostgreSQL + MinIO + Redis + Mailpit + Backend + Frontend
docker compose -f docker-compose.local.yaml up -d

# 查看启动日志
docker compose -f docker-compose.local.yaml logs -f
```

**包含的服务**：
- ✅ PostgreSQL (数据库) - localhost:5432
- ✅ MinIO (对象存储) - localhost:9000
- ✅ Redis (缓存) - localhost:6379
- ✅ Mailpit (邮件测试) - localhost:8025
- ✅ Backend (后端 API) - localhost:8000
- ✅ Frontend (前端) - localhost:3000

#### 5. 构建 Docker 沙箱镜像
```bash
# 在新的终端窗口（首次运行需要）
docker build -t kortix-sandbox:latest -f backend\core\sandbox\Dockerfile .
```

#### 6. 访问应用 🎉
```
✅ 前端：http://localhost:3000
✅ 后端API：http://localhost:8000/docs
✅ MinIO控制台：http://localhost:9001 (minioadmin/minioadmin)
✅ Mailpit邮件：http://localhost:8025
```

**架构图**：
```
本地 Docker 容器:
  - PostgreSQL (数据库)
  - MinIO (文件存储)
  - Redis (缓存)
  - Mailpit (邮件测试)
  - Backend (后端)
  - Frontend (前端)
  - Docker Sandbox (代码执行)

阿里云:
  - 百炼 DashScope (大语言模型) ☁️
```

---

### 方案二：完全本地部署（使用 Ollama 本地 LLM）

如果你想完全免费、完全离线，可以使用 Ollama 替代阿里云百炼。

#### 额外步骤：

**1. 安装 Ollama**
- Windows: https://ollama.ai/download
- 安装后自动启动

**2. 拉取模型**
```bash
# 中文优化模型（推荐）
ollama pull qwen2.5:7b

# 或其他模型
ollama pull llama3.1:8b
ollama pull deepseek-coder:6.7b
```

**3. 修改 .env 配置**
```bash
# LLM 使用 Ollama（本地）
MAIN_LLM=ollama
MAIN_LLM_MODEL=qwen2.5:7b
OLLAMA_BASE_URL=http://host.docker.internal:11434

# 不需要 DASHSCOPE_API_KEY
```

**4. 启动服务（相同）**
```bash
docker compose -f docker-compose.local.yaml up -d
```

#### 1. 克隆项目
```bash
cd D:\project\local-suna
```

#### 2. 配置环境变量
```bash
# 复制中国化本地配置模板
copy .env.local.example .env

# 配置已经预设好了，无需修改！
```

#### 3. 安装 Ollama 模型
```bash
# 拉取中文优化的 Qwen 模型（推荐）
ollama pull qwen2.5:7b

# 或者其他模型：
# ollama pull llama3.1:8b
# ollama pull deepseek-coder:6.7b
```

#### 4. 启动所有服务
```bash
# 使用中国化配置启动
docker compose -f docker-compose.local.yaml up -d

# 查看日志
docker compose -f docker-compose.local.yaml logs -f
```

#### 5. 构建 Docker 沙箱镜像
```bash
# 在新的终端窗口
docker build -t kortix-sandbox:latest -f backend\core\sandbox\Dockerfile .
```

#### 6. 安装前端依赖并启动
```bash
# 在新的终端窗口
# 安装依赖（首次运行）
pnpm install

# 启动前端开发服务器
cd apps\frontend
pnpm dev
```

#### 7. 安装后端依赖并启动
```bash
# 在新的终端窗口
cd backend

# 安装依赖（首次运行）
poetry install

# 运行数据库迁移
poetry run alembic upgrade head

# 启动后端
poetry run python api.py
```

#### 8. 访问应用 🎉
```
前端：http://localhost:3000
后端API：http://localhost:8000/docs
MinIO控制台：http://localhost:9001 (minioadmin/minioadmin)
Mailpit邮件：http://localhost:8025
PostgreSQL：localhost:5432 (kortix/kortix123)
```

---

---

### 方式三：使用项目自带的启动脚本

#### 1. 运行 setup 向导（首次）
```bash
python setup.py
```

按照向导提示：
- 选择 **Docker** 安装方式
- 配置 Supabase（可选择 Cloud 或跳过）
- 配置 LLM 提供商（选择 Ollama）

#### 2. 启动服务
```bash
python start.py
```

或者：
```bash
python start.py start    # 直接启动
python start.py stop     # 停止
python start.py status   # 查看状态
```

---

## 🔧 服务说明

### docker-compose.local.yaml 包含的服务

| 服务 | 端口 | 说明 |
|------|------|------|
| **postgres** | 5432 | PostgreSQL 14 数据库 |
| **minio** | 9000, 9001 | MinIO 对象存储（S3兼容） |
| **redis** | 6379 | Redis 缓存 |
| **mailpit** | 1025, 8025 | 邮件测试工具 |
| **backend** | 8000 | Kortix 后端 API |
| **frontend** | 3000 | Kortix 前端 |

### 环境变量配置（.env）

已在 `.env.local.example` 中预配置：

```bash
# 云服务商
CLOUD_PROVIDER=local

# 数据库（自动连接 Docker PostgreSQL）
DATABASE_PROVIDER=local
LOCAL_DB_HOST=postgres
LOCAL_DB_PASSWORD=kortix123

# 存储（自动连接 MinIO）
STORAGE_PROVIDER=local
MINIO_ENDPOINT=minio:9000
MINIO_BUCKET=kortix-files

# LLM（使用 Ollama 本地）
MAIN_LLM=ollama
MAIN_LLM_MODEL=qwen2.5:7b
OLLAMA_BASE_URL=http://host.docker.internal:11434

# 沙箱（Docker）
SANDBOX_PROVIDER=docker

# 通知（本地 SMTP）
NOTIFICATION_PROVIDER=local_smtp
SMTP_HOST=mailpit
SMTP_PORT=1025

# 支付（Mock，开发测试用）
PAYMENT_PROVIDER=local_mock
```

---

## 🐛 常见问题

### Q: Docker 启动失败？

**A**: 确保 Docker Desktop 正在运行：
```bash
# 检查 Docker 状态
docker version

# 重启 Docker Desktop
# Windows: 从任务栏图标右键 -> Restart
```

### Q: 端口被占用？

**A**: 停止占用端口的服务：
```bash
# 查看端口占用（Windows）
netstat -ano | findstr :3000
netstat -ano | findstr :8000

# 杀死进程（替换 PID）
taskkill /F /PID <PID>
```

### Q: 阿里云百炼 API 调用失败？

**A**: 检查配置：
```bash
# 1. 确认 API Key 正确（检查 .env 文件）
# 2. 确认已充值（百炼按使用量付费）
# 3. 测试 API
curl -X POST https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation \
  -H "Authorization: Bearer sk-你的API_KEY" \
  -H "Content-Type: application/json" \
  -d "{\"model\":\"qwen-turbo\",\"input\":{\"messages\":[{\"role\":\"user\",\"content\":\"你好\"}]}}"
```

**常见错误**：
- `401 Unauthorized`: API Key 错误或未设置
- `403 Forbidden`: 账户欠费或未开通服务
- `429 Too Many Requests`: 请求过于频繁

### Q: 前端启动报错 "module not found"？

**A**: 重新安装依赖：
```bash
# 删除 node_modules 和 lockfile
rm -rf node_modules pnpm-lock.yaml

# 重新安装
pnpm install
```

### Q: 后端启动报错 "ModuleNotFoundError"？

**A**: 重新安装依赖：
```bash
cd backend

# 重新安装
poetry install

# 如果还有问题，清除缓存
poetry cache clear . --all
poetry install
```

### Q: 数据库连接失败？

**A**: 确保 PostgreSQL 容器正在运行：
```bash
# 检查容器状态
docker compose -f docker-compose.local.yaml ps

# 查看 PostgreSQL 日志
docker compose -f docker-compose.local.yaml logs postgres

# 重启 PostgreSQL
docker compose -f docker-compose.local.yaml restart postgres
```

### Q: MinIO 初始化失败？

**A**: 手动创建 bucket：
```bash
# 访问 MinIO 控制台
# http://localhost:9001
# 用户名: minioadmin
# 密码: minioadmin

# 创建名为 "kortix-files" 的 bucket
# Access Policy 设置为 "Public"
```

### Q: Ollama 连接失败？（方案二）

**A**: 确保 Ollama 正在运行：
```bash
# 检查 Ollama 状态
ollama list

# 如未运行，启动 Ollama
# Windows: 从开始菜单启动 Ollama

# 测试 Ollama
ollama run qwen2.5:7b "你好"
```

### Q: 前端启动报错 "module not found"？

**A**: 重新安装依赖：
```bash
# 删除 node_modules 和 lockfile
rm -rf node_modules pnpm-lock.yaml

# 重新安装
pnpm install
```

### Q: 后端启动报错 "ModuleNotFoundError"？

**A**: 重新安装依赖：
```bash
cd backend

# 重新安装
poetry install

# 如果还有问题，清除缓存
poetry cache clear . --all
poetry install
```

### Q: 数据库连接失败？

**A**: 确保 PostgreSQL 容器正在运行：
```bash
# 检查容器状态
docker compose -f docker-compose.local.yaml ps

# 查看 PostgreSQL 日志
docker compose -f docker-compose.local.yaml logs postgres

# 重启 PostgreSQL
docker compose -f docker-compose.local.yaml restart postgres
```

### Q: MinIO 初始化失败？

**A**: 手动创建 bucket：
```bash
# 访问 MinIO 控制台
# http://localhost:9001
# 用户名: minioadmin
# 密码: minioadmin

# 创建名为 "kortix-files" 的 bucket
# Access Policy 设置为 "Public"
```

---

## 🧹 清理和重置

### 停止所有服务
```bash
# 停止所有 Docker 容器
docker compose -f docker-compose.local.yaml down
```

### 清除所有数据（重置）
```bash
# 停止并删除所有容器和数据卷
docker compose -f docker-compose.local.yaml down -v

# 重新启动
docker compose -f docker-compose.local.yaml up -d
```

### 完全清理
```bash
# 删除所有 Docker 资源
docker system prune -a --volumes

# 删除 node_modules
rm -rf node_modules apps/*/node_modules packages/*/node_modules

# 删除 Python 虚拟环境
cd backend
poetry env remove --all
```

### 清除所有数据（重置）
```bash
# 停止并删除所有容器和数据卷
docker compose -f docker-compose.local.yaml down -v

# 重新启动
docker compose -f docker-compose.local.yaml up -d
```

### 完全清理
```bash
# 删除所有 Docker 资源
docker system prune -a --volumes

# 删除 node_modules
rm -rf node_modules apps/*/node_modules packages/*/node_modules

# 删除 Python 虚拟环境
cd backend
poetry env remove --all
```

---

## 📊 验证安装

### 1. 检查服务状态
```bash
docker compose -f docker-compose.local.yaml ps
```

应该看到所有服务都是 "Up"：
```
NAME                  STATUS
kortix-postgres       Up
kortix-minio          Up  
kortix-redis          Up
kortix-mailpit        Up
kortix-backend        Up
kortix-frontend       Up
```

### 2. 测试各个服务

**前端**:
```bash
curl http://localhost:3000
# 应该返回 HTML 页面
```

**后端 API**:
```bash
curl http://localhost:8000/health
# 应该返回 {"status": "ok"}
```

**PostgreSQL**:
```bash
docker exec kortix-postgres psql -U kortix -d kortix -c "SELECT version();"
```

**MinIO**:
```bash
curl http://localhost:9000/minio/health/live
# 应该返回 200 OK
```

**阿里云百炼 LLM**（推荐方案）:
```bash
# 在应用中发起对话，查看后端日志
docker compose -f docker-compose.local.yaml logs -f backend

# 应该看到 DashScope API 调用成功
```

**Ollama LLM**（方案二）:
```bash
curl http://localhost:11434/api/tags
# 应该返回已安装的模型列表
```

### 2. 测试各个服务

**前端**:
```bash
curl http://localhost:3000
# 应该返回 HTML 页面
```

**后端 API**:
```bash
curl http://localhost:8000/health
# 应该返回 {"status": "ok"}
```

**PostgreSQL**:
```bash
docker exec kortix-postgres psql -U kortix -d kortix -c "SELECT version();"
```

**MinIO**:
```bash
curl http://localhost:9000/minio/health/live
# 应该返回 200 OK
```

**Ollama**:
```bash
curl http://localhost:11434/api/tags
# 应该返回已安装的模型列表
```

---

## 🎓 下一步

### 学习资源

1. **查看完整文档**
   - 项目总结: `README_CHINA.md`
   - 部署指南: `docs/CHINA_DEPLOYMENT_GUIDE.md`
   - LLM提供商: `docs/CHINA_LLM_PROVIDERS.md`

2. **探索代码**
   - 后端 API: http://localhost:8000/docs (Swagger UI)
   - 前端代码: `apps/frontend/`
   - 后端代码: `backend/`

3. **测试功能**
   - 创建 AI Agent
   - 对话测试
   - 文件上传
   - 代码执行（Docker 沙箱）

### 进阶配置

**切换 LLM 模型**:
```bash
# 编辑 .env

# 推荐方案：阿里云百炼
DASHSCOPE_API_KEY=sk-你的密钥
MAIN_LLM=dashscope

# 使用经济型模型（更便宜）
MAIN_LLM_MODEL=qwen-turbo      # ¥2/百万tokens

# 使用更强的模型（更贵）
MAIN_LLM_MODEL=qwen-plus       # ¥4/百万tokens
MAIN_LLM_MODEL=qwen-max        # ¥40/百万tokens

# 使用长文本模型
MAIN_LLM_MODEL=qwen-long       # ¥0.5/百万tokens，支持100万tokens上下文

# 方案二：切换到本地 Ollama（免费）
MAIN_LLM=ollama
MAIN_LLM_MODEL=qwen2.5:7b
OLLAMA_BASE_URL=http://host.docker.internal:11434

# 其他云端选择：智谱AI
ZHIPU_API_KEY=your-key
MAIN_LLM=zhipu
MAIN_LLM_MODEL=glm-4
```

**调整 Docker 资源**:
```bash
# 如果 Docker 容器启动慢或卡顿
# 打开 Docker Desktop -> Settings -> Resources
# 增加：
# - CPUs: 4+
# - Memory: 8GB+
# - Swap: 2GB+
```

**部署到云端**:
- 参考 `docs/CHINA_DEPLOYMENT_GUIDE.md`
- 阿里云/腾讯云完整部署流程

---

## 🆘 获取帮助

遇到问题？

1. 检查日志：
   ```bash
   docker compose -f docker-compose.local.yaml logs -f
   ```

2. 查看文档：
   - `README_CHINA.md`
   - `docs/` 目录

3. 常见问题已在上方列出

---

## 📝 配置检查清单

### 推荐方案：本地 + 百炼

启动前确保：

- [ ] Docker Desktop 正在运行
- [ ] 阿里云百炼 API Key 已获取
- [ ] Node.js 20+ 已安装
- [ ] pnpm 已安装
- [ ] Python 3.11+ 已安装
- [ ] Poetry 已安装
- [ ] `.env` 文件已创建（复制自 `.env.local.example`）
- [ ] `.env` 中 `DASHSCOPE_API_KEY` 已填写
- [ ] 端口 3000, 8000, 5432, 9000, 9001, 6379 未被占用

### 方案二：完全本地

启动前确保：

- [ ] Docker Desktop 正在运行
- [ ] Ollama 已安装并拉取模型
- [ ] Node.js 20+ 已安装
- [ ] pnpm 已安装
- [ ] Python 3.11+ 已安装
- [ ] Poetry 已安装
- [ ] `.env` 文件已创建（复制自 `.env.local.example`）
- [ ] `.env` 中 `MAIN_LLM=ollama` 已配置
- [ ] 端口 3000, 8000, 5432, 9000, 9001, 6379 未被占用

---

**祝你使用愉快！** 🎉

如有问题，请查看上方常见问题部分或查阅完整文档。
