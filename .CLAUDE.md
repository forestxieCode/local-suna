# Kortix AI Agent Platform - Claude AI Assistant Guide

## 项目概述

Kortix 是一个完整的 AI Agent 平台，用于创建、管理和训练能够自主工作的 AI 代理。本项目包含旗舰产品 Kortix Super Worker（通用 AI 工作者）以及用于构建自定义 AI 代理的完整平台能力。

**项目名称**: Kortix (原 AgentPress/Suna)  
**版本**: 1.0  
**许可证**: Apache-2.0  
**仓库**: https://github.com/kortix-ai/suna

## 技术栈

### 前端技术栈
- **框架**: Next.js 15.3.8 (App Router, Turbopack)
- **运行时**: React 18
- **语言**: TypeScript 5
- **样式**: Tailwind CSS 4
- **UI 组件库**:
  - Radix UI (完整组件集)
  - Shadcn UI 风格
  - Lucide React 图标
  - Framer Motion 动画
- **状态管理**:
  - Zustand (全局状态)
  - TanStack React Query (服务端状态)
- **表单**: React Hook Form + Zod
- **富文本编辑**: Tiptap (Markdown, 协作编辑)
- **代码编辑器**: CodeMirror 6
- **数据可视化**: Recharts, Chart.js
- **特殊功能**:
  - PDF 渲染: react-pdf, pdfjs-dist
  - Excel: @syncfusion/ej2-react-spreadsheet
  - 终端: @xterm/xterm
  - Canvas: Konva, react-konva

### 后端技术栈
- **框架**: FastAPI 0.115.12
- **运行时**: Python 3.11+
- **Web 服务器**: Uvicorn 0.27.1, Gunicorn
- **数据库 ORM**: Prisma 0.15.0
- **认证**: Supabase 2.17.0, PyJWT 2.10.1
- **缓存**: Redis 5.2.1, Upstash Redis
- **LLM 集成**:
  - LiteLLM (统一 LLM 接口)
  - Anthropic, OpenAI, Groq 等
  - 阿里百炼 (dashscope) - 中国区
  - Ollama (本地部署)
- **AI 工具**:
  - Langfuse (可观测性)
  - Composio (工具集成)
  - MCP (Model Context Protocol)
- **沙箱执行**:
  - Docker 7.0+ (主要，中国友好)
  - E2B Code Interpreter
  - Daytona SDK (废弃)
- **云服务集成**:
  - **阿里云**: OSS (oss2), 百炼 LLM, SMS
  - **腾讯云**: COS, SDK
  - **通用**: MinIO, Boto3

### 基础设施
- **容器化**: Docker, Docker Compose
- **数据库**: PostgreSQL (via Supabase)
- **对象存储**: 
  - Supabase Storage
  - 阿里云 OSS
  - 腾讯云 COS
  - MinIO (本地)
- **缓存**: Redis
- **部署方式**:
  - Docker Compose (推荐)
  - 手动部署 (开发)
  - 云端部署 (阿里云/腾讯云全家桶)

## 项目架构

```
local-suna/
├── apps/
│   ├── frontend/          # Next.js 前端应用
│   ├── mobile/            # 移动端应用
│   └── desktop/           # 桌面应用
├── backend/               # FastAPI 后端服务
│   ├── api.py            # 主 API 入口
│   ├── core/             # 核心业务逻辑
│   │   ├── agents/       # Agent 管理
│   │   ├── agentpress/   # AgentPress 核心
│   │   ├── ai_models/    # AI 模型抽象
│   │   ├── auth/         # 认证授权
│   │   ├── sandbox/      # 沙箱执行环境
│   │   ├── storage/      # 存储抽象层
│   │   ├── tools/        # Agent 工具集
│   │   ├── threads/      # 对话线程管理
│   │   └── mcp_module/   # MCP 集成
│   ├── services/         # 外部服务集成
│   ├── supabase/         # Supabase 配置
│   └── tests/            # 测试
├── packages/             # 共享包
│   └── shared/           # 前后端共享代码
├── scripts/              # 脚本工具
├── docs/                 # 文档
│   ├── CHINA_DEPLOYMENT_GUIDE.md      # 中国区部署指南
│   ├── CHINA_LLM_PROVIDERS.md         # 中国 LLM 提供商对比
│   ├── CHINA_PROJECT_SUMMARY.md       # 中国化项目总结
│   └── DOCKER_SANDBOX_QUICKSTART.md   # Docker 沙箱快速开始
├── setup/                # 安装向导
├── docker-compose.yaml           # 生产环境 Docker Compose
├── docker-compose.local.yaml     # 本地开发 Docker Compose
├── setup.py              # 交互式设置向导
├── start.py              # 服务管理器
└── README_CHINA.md       # 中国区快速开始

Monorepo 结构:
- 使用 pnpm workspace
- 前端: apps/* 和 packages/*
- 后端: backend/ (独立 Python 项目)
```

## 核心功能

### 1. Agent 能力
- **浏览器自动化**: 网页导航、数据提取、表单填写
- **文件管理**: 创建、编辑文档、电子表格、演示文稿、代码
- **网络智能**: 爬虫、搜索、数据提取和综合
- **系统操作**: 命令行执行、系统管理、DevOps 任务
- **API 集成**: 外部服务连接、跨平台工作流自动化
- **Agent 构建器**: 可视化工具配置、自定义和部署 Agent

### 2. 沙箱执行环境
- **Docker 沙箱** (主要):
  - 隔离的容器执行环境
  - 浏览器自动化
  - 代码解释器
  - 文件系统访问
  - 安全沙箱隔离
  - 可扩展的 Agent 部署
- **E2B Code Interpreter** (备用)
- **Daytona SDK** (已废弃，使用 Docker 替代)

### 3. 中国区特性
- **本地部署**: 无需 VPN，使用 Ollama + Docker
- **云端部署**: 阿里云全家桶、腾讯云全家桶或混合部署
- **LLM 提供商**:
  - 阿里百炼 (Qwen 系列)
  - 智谱 AI (GLM 系列)
  - Ollama 本地 (qwen2.5:7b 等)
- **对象存储**: 阿里云 OSS、腾讯云 COS、MinIO
- **数据库**: 阿里云 RDS、腾讯云 TDSQL、本地 PostgreSQL

## 开发指南

### 前端开发

#### 启动开发服务器
```bash
pnpm dev:frontend
# 或
cd apps/frontend
pnpm dev
```

#### 构建
```bash
pnpm build:frontend
```

#### 代码风格
- 使用 TypeScript 严格模式关闭 (`strict: false`)
- 使用 Tailwind CSS 实用类优先
- 使用 `@/` 作为 src 目录别名
- 组件库优先使用 Radix UI
- 表单使用 React Hook Form + Zod 验证
- 状态管理: 服务端状态用 React Query, 客户端状态用 Zustand

#### 关键目录
```
apps/frontend/src/
├── app/              # Next.js App Router 页面
├── components/       # React 组件
│   ├── ui/          # 基础 UI 组件 (Radix UI)
│   └── ...          # 业务组件
├── lib/             # 工具函数
├── hooks/           # 自定义 Hooks
├── stores/          # Zustand 状态管理
└── styles/          # 全局样式
```

### 后端开发

#### 启动开发服务器
```bash
cd backend
uvicorn api:app --reload --port 8000
```

#### 依赖管理
```bash
# 使用 uv (推荐)
uv pip install <package>

# 或使用 poetry
poetry add <package>
```

#### 代码风格
- 使用 Python 3.11+ 特性
- 遵循 PEP 8 规范
- 使用 FastAPI 的依赖注入系统
- 使用 Pydantic 进行数据验证
- 异步优先 (async/await)
- 使用 Prisma 进行数据库操作

#### 关键模块
```
backend/core/
├── agentpress/           # AgentPress 核心引擎
├── agents/               # Agent 管理
├── ai_models/            # LLM 抽象层
├── auth/                 # 认证授权
├── sandbox/              # 沙箱执行
│   ├── docker/          # Docker 沙箱 (主要)
│   ├── e2b/             # E2B 沙箱 (备用)
│   └── daytona/         # Daytona (废弃)
├── storage/              # 存储抽象层
│   ├── providers/
│   │   ├── aliyun_oss.py    # 阿里云 OSS
│   │   ├── tencent_cos.py   # 腾讯云 COS
│   │   └── minio.py         # MinIO
├── tools/                # Agent 工具集
├── threads/              # 对话线程
└── mcp_module/           # MCP 集成
```

### 数据库

#### Prisma 管理
```bash
cd backend

# 生成 Prisma 客户端
npx prisma generate

# 推送 schema 到数据库
npx prisma db push

# 打开 Prisma Studio
npx prisma studio
```

#### 数据库连接
- 使用 Supabase PostgreSQL
- 连接信息在 `.env` 文件中
- 通过 Prisma ORM 访问

### 测试

#### 后端测试
```bash
cd backend
pytest
pytest -v  # 详细模式
pytest tests/specific_test.py  # 运行特定测试
```

#### 测试标记
- `@pytest.mark.e2e`: 端到端测试
- `@pytest.mark.slow`: 耗时测试 (>30s)
- `@pytest.mark.large_context`: 大上下文测试 (200k+ tokens)

## 配置管理

### 环境变量

#### 前端 (.env)
```bash
NEXT_PUBLIC_BACKEND_URL=http://localhost:8000/v1
NEXT_PUBLIC_URL=http://localhost:3000
NEXT_PUBLIC_ENV_MODE=LOCAL
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
```

#### 后端 (.env)
```bash
# Supabase
SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=
DATABASE_URL=

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_SSL=False

# LLM Providers
ANTHROPIC_API_KEY=
OPENAI_API_KEY=
GROQ_API_KEY=

# 中国区 LLM
DASHSCOPE_API_KEY=  # 阿里百炼
OLLAMA_BASE_URL=http://localhost:11434

# 沙箱
SANDBOX_PROVIDER=docker  # 或 e2b
DOCKER_SANDBOX_IMAGE=

# 存储
STORAGE_PROVIDER=supabase  # 或 aliyun_oss, tencent_cos, minio
ALIYUN_OSS_ACCESS_KEY_ID=
ALIYUN_OSS_ACCESS_KEY_SECRET=
ALIYUN_OSS_ENDPOINT=
ALIYUN_OSS_BUCKET_NAME=
```

### 配置文件示例
- `.env.local.example`: 本地部署模板
- `.env.aliyun.example`: 阿里云部署模板
- `.env.tencent.example`: 腾讯云部署模板

## 部署指南

### 本地 Docker 部署 (推荐)

```bash
# 1. 运行设置向导
python setup.py

# 2. 启动服务
python start.py start

# 或直接使用 Docker Compose
docker compose -f docker-compose.local.yaml up -d

# 访问应用
# 前端: http://localhost:3000
# 后端: http://localhost:8000
```

### 中国区本地部署 (完全免费)

```bash
# 1. 安装依赖
# - Docker Desktop
# - Ollama

# 2. 启动服务
docker compose -f docker-compose.local.yaml up -d

# 3. 拉取本地 LLM
ollama pull qwen2.5:7b

# 访问应用
# 前端: http://localhost:3000
# 后端: http://localhost:8000
```

### 云端部署
参考文档:
- [中国区部署指南](docs/CHINA_DEPLOYMENT_GUIDE.md)
- [LLM 提供商对比](docs/CHINA_LLM_PROVIDERS.md)
- [Docker 沙箱快速开始](docs/DOCKER_SANDBOX_QUICKSTART.md)

## 常见任务

### 添加新的 Agent 工具
1. 在 `backend/core/tools/` 创建新工具模块
2. 继承 `BaseTool` 类
3. 实现 `execute()` 方法
4. 在 `backend/core/tools/__init__.py` 注册工具

### 添加新的 LLM 提供商
1. 在 `backend/core/ai_models/providers/` 创建新提供商
2. 实现 LiteLLM 兼容接口
3. 在配置中添加 API 密钥
4. 在 Agent 配置中选择新提供商

### 添加新的存储提供商
1. 在 `backend/core/storage/providers/` 创建新提供商
2. 继承 `BaseStorageProvider` 接口
3. 实现 `upload()`, `download()`, `delete()` 等方法
4. 在配置中设置 `STORAGE_PROVIDER`

### 添加新的沙箱提供商
1. 在 `backend/core/sandbox/` 创建新提供商
2. 实现 `execute_code()`, `execute_command()` 等接口
3. 在配置中设置 `SANDBOX_PROVIDER`

## 调试技巧

### 前端调试
- 使用 React DevTools
- 使用 TanStack Query DevTools
- 在浏览器控制台查看日志
- 使用 Next.js 内置错误页面

### 后端调试
- 使用 FastAPI 交互式文档: http://localhost:8000/docs
- 查看日志: `tail -f backend.log`
- 使用 Python debugger (pdb)
- 使用 Langfuse 查看 LLM 调用链

### Docker 调试
```bash
# 查看所有服务日志
docker compose logs -f

# 查看特定服务
docker compose logs -f backend
docker compose logs -f frontend

# 进入容器
docker compose exec backend bash
docker compose exec frontend sh

# 重启服务
docker compose restart backend
```

## 性能优化

### 前端优化
- 使用 Next.js 15 Turbopack 构建
- 使用 React Query 进行数据缓存
- 使用动态导入 (dynamic import) 减小包体积
- 使用 `next/image` 优化图片
- 使用 `orjson` 进行 JSON 序列化 (3-5x 更快)

### 后端优化
- 使用 Redis 缓存频繁访问的数据
- 使用 LiteLLM 缓存 LLM 响应
- 使用异步 I/O (FastAPI + asyncio)
- 使用连接池管理数据库连接
- 使用 CDN 加速静态资源

## 安全考虑

### 沙箱安全
- 使用 Docker 容器隔离执行环境
- 限制容器资源 (CPU, 内存)
- 禁用不必要的系统调用
- 使用只读文件系统 (除工作目录)

### 认证授权
- 使用 Supabase 认证
- 使用 JWT 进行 API 鉴权
- 使用 Row Level Security (RLS)
- API 密钥加密存储

### 数据安全
- 使用 HTTPS 传输
- 数据库连接使用 SSL
- 敏感数据加密存储
- 定期备份数据

## 监控和日志

### 日志记录
- 使用 structlog (后端)
- 使用 CloudWatch Logs (生产环境)
- 使用 Langfuse 记录 LLM 调用

### 性能监控
- 使用 Prometheus Client
- 使用 Vercel Analytics (前端)
- 使用 PostHog (用户行为分析)

### 错误追踪
- 使用 FastAPI 异常处理
- 使用 Next.js 错误边界
- 集成 Sentry (可选)

## 贡献指南

1. Fork 仓库
2. 创建特性分支: `git checkout -b feature/amazing-feature`
3. 提交更改: `git commit -m 'Add amazing feature'`
4. 推送到分支: `git push origin feature/amazing-feature`
5. 创建 Pull Request

### 代码审查标准
- 遵循项目代码风格
- 添加适当的测试
- 更新相关文档
- 确保 CI/CD 通过

## 常见问题

### Q: 如何切换 LLM 提供商?
A: 在 `.env` 文件中配置相应的 API 密钥，然后在 Agent 设置中选择提供商。

### Q: 如何使用本地 LLM?
A: 安装 Ollama，拉取模型 (`ollama pull qwen2.5:7b`)，在配置中设置 `OLLAMA_BASE_URL`。

### Q: 如何切换存储提供商?
A: 在 `.env` 文件中设置 `STORAGE_PROVIDER` 为 `aliyun_oss`, `tencent_cos`, `minio` 或 `supabase`。

### Q: 如何在中国使用?
A: 参考 [README_CHINA.md](README_CHINA.md) 和 [docs/CHINA_DEPLOYMENT_GUIDE.md](docs/CHINA_DEPLOYMENT_GUIDE.md)。

### Q: Docker 沙箱如何工作?
A: 参考 [docs/DOCKER_SANDBOX_QUICKSTART.md](docs/DOCKER_SANDBOX_QUICKSTART.md)。

## 资源链接

- **官网**: https://www.kortix.com
- **GitHub**: https://github.com/kortix-ai/suna
- **Discord**: https://discord.com/invite/RvFhXUdZ9H
- **Twitter**: https://x.com/kortix
- **文档**: 
  - [自托管指南](docs/SELF-HOSTING.md)
  - [中国化项目总结](README_CHINA.md)
  - [完整部署指南](docs/CHINA_DEPLOYMENT_GUIDE.md)

## AI 助手使用建议

当使用 Claude 或其他 AI 助手协助开发时:

1. **理解项目结构**: 先熟悉 monorepo 结构和技术栈
2. **参考现有代码**: 保持与现有代码风格一致
3. **测试驱动**: 修改代码后运行相关测试
4. **增量修改**: 进行小而精确的修改，避免大规模重构
5. **文档优先**: 参考项目文档和注释
6. **中国区特性**: 注意中国区特殊配置和部署方式
7. **沙箱选择**: 优先使用 Docker 沙箱 (中国友好)

---

**最后更新**: 2026-02-03  
**维护者**: Kortix Team  
**版本**: 1.0
